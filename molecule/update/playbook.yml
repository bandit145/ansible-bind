---
- name: Converge
  hosts: all
  become: true
  vars:
    isc_bind_keys:
      - name: testkey
        algorithim: hmac-sha512
        secret: Bt890tlZHCNMl95QMAx2WtKh9vH4ZjF//UG0Uwp/RGK1fiAOIoNtHyPaf6YEN/PH/uAwQaH7f8iStNPQ50Gmlg==
    isc_bind_zones:
      - name: test.com
        type: master
        soa: ns1.test.com
        contact: phil@test.com
        records:
          - test.com. IN NS ns1.test.com.
          - ns1 IN A 192.168.1.2
          - otherrecord IN A 192.168.1.3
      - name: dynamic.com
        type: master
        soa: ns1.dynamic.com
        contact: phil@test.com
        records:
          - dynamic.com. IN NS ns1.dynamic.com.
          - ns1 IN A 192.168.1.2
        allow_update:
          - key testkey
  pre_tasks:
    - name: stat dynamic.com
      stat:
        path: /var/named/db.dynamic.com
      register: dynamic_exists

    - name: copy dynamic zone
      lineinfile:
        path: /var/named/db.dynamic.com
        line: "combine-record IN A 192.168.1.3"
      when: dynamic_exists.stat.exists

  roles:
    - role: ansible-bind
